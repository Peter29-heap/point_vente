<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Ventes - KYA DRINKS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const storage = {
          get: async (key) => {
            try {
              const value = localStorage.getItem(key);
              return value ? { key, value } : null;
            } catch (error) {
              console.error('Erreur lecture storage:', error);
              return null;
            }
          },
          set: async (key, value) => {
            try {
              localStorage.setItem(key, value);
              return { key, value };
            } catch (error) {
              console.error('Erreur √©criture storage:', error);
              return null;
            }
          },
          delete: async (key) => {
            try {
              localStorage.removeItem(key);
              return { key, deleted: true };
            } catch (error) {
              console.error('Erreur suppression storage:', error);
              return null;
            }
          }
        };

        // Icons
        const Plus = () => <span>‚ûï</span>;
        const Trash2 = () => <span>üóëÔ∏è</span>;
        const Calendar = () => <span>üìÖ</span>;
        const DollarSign = () => <span>üí∞</span>;
        const Package = () => <span>üì¶</span>;
        const Upload = () => <span>‚¨ÜÔ∏è</span>;
        const Download = () => <span>‚¨áÔ∏è</span>;
        const FileSpreadsheet = () => <span>üìä</span>;
        const TrendingUp = () => <span>üìà</span>;
        const Award = () => <span>üèÜ</span>;

        function SalesTracker() {
          const [sales, setSales] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [showTopProducts, setShowTopProducts] = useState(false);
          const [formData, setFormData] = useState({
            date: new Date().toISOString().split('T')[0],
            article: '',
            quantity: 1,
            unitPrice: ''
          });
          const [dateFilter, setDateFilter] = useState({
            startDate: '',
            endDate: ''
          });
          const [importing, setImporting] = useState(false);
          const fileInputRef = useRef(null);

          useEffect(() => {
            loadSales();
          }, []);

          const loadSales = async () => {
            try {
              const result = await storage.get('sales-data');
              if (result && result.value) {
                setSales(JSON.parse(result.value));
              }
            } catch (error) {
              console.log('Aucune donn√©e sauvegard√©e');
            }
          };

          const saveSales = async (newSales) => {
            try {
              await storage.set('sales-data', JSON.stringify(newSales));
            } catch (error) {
              console.error('Erreur de sauvegarde:', error);
            }
          };

          const parseExcelDate = (dateValue) => {
            if (!dateValue) return null;

            if (typeof dateValue === 'string') {
              const parts = dateValue.split('/');
              if (parts.length === 3) {
                const [day, month, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              }
              if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateValue;
              }
            }

            if (typeof dateValue === 'number') {
              const date = new Date((dateValue - 25569) * 86400 * 1000);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }

            return null;
          };

          const handleFileImport = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setImporting(true);
            try {
              const data = await file.arrayBuffer();
              const workbook = XLSX.read(data);
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);

              const importedSales = jsonData
                .map((row, index) => {
                  const date = parseExcelDate(
                    row['Date'] || row['date'] || row['DATE']
                  );
                  const article = row['Article'] || row['article'] || row['ARTICLE'] || '';
                  const quantity = parseInt(row['Quantit√©'] || row['Quantite'] || row['quantity'] || row['QUANTITY'] || 1);
                  const unitPrice = parseFloat(
                    String(row['Prix Unitaire'] || row['Prix Unit.'] || row['unitPrice'] || row['PRIX UNITAIRE'] || 0)
                      .replace(/\s/g, '')
                      .replace('XOF', '')
                      .replace(',', '.')
                  );
                  const total = parseFloat(
                    String(row['Total'] || row['total'] || row['TOTAL'] || (quantity * unitPrice))
                      .replace(/\s/g, '')
                      .replace('XOF', '')
                      .replace(',', '.')
                  );

                  if (!date || !article || !unitPrice) {
                    console.warn(`Ligne ${index + 2} ignor√©e:`, row);
                    return null;
                  }

                  return {
                    id: Date.now() + index,
                    date,
                    article: article.trim(),
                    quantity,
                    unitPrice,
                    total
                  };
                })
                .filter(Boolean);

              if (importedSales.length === 0) {
                alert('‚ùå Aucune donn√©e valide trouv√©e dans le fichier.\n\nAssurez-vous que les colonnes sont nomm√©es:\n- Date\n- Article\n- Quantit√©\n- Prix Unitaire\n- Total');
                return;
              }

              const updatedSales = [...sales, ...importedSales];
              setSales(updatedSales);
              await saveSales(updatedSales);

              alert(`‚úÖ ${importedSales.length} ventes import√©es avec succ√®s !`);
              event.target.value = '';
            } catch (error) {
              console.error('Erreur import:', error);
              alert('‚ùå Erreur lors de l\'importation du fichier.\n\n' + error.message);
            } finally {
              setImporting(false);
            }
          };

          const exportToExcel = () => {
            const worksheet = XLSX.utils.json_to_sheet(
              sales.map(s => ({
                'Date': new Date(s.date).toLocaleDateString('fr-FR'),
                'Article': s.article,
                'Quantit√©': s.quantity,
                'Prix Unitaire': s.unitPrice,
                'Total': s.total
              }))
            );
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Ventes');
            XLSX.writeFile(workbook, `ventes_${new Date().toISOString().split('T')[0]}.xlsx`);
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            const price = parseFloat(formData.unitPrice);
            if (!formData.article || !price || price <= 0) {
              alert('Veuillez remplir tous les champs correctement');
              return;
            }
            const newSale = {
              id: Date.now(),
              date: formData.date,
              article: formData.article,
              quantity: formData.quantity,
              unitPrice: price,
              total: formData.quantity * price
            };
            const updatedSales = [...sales, newSale];
            setSales(updatedSales);
            saveSales(updatedSales);
            setFormData({
              date: new Date().toISOString().split('T')[0],
              article: '',
              quantity: 1,
              unitPrice: ''
            });
            setShowForm(false);
          };

          const deleteSale = (id) => {
            if (confirm('Supprimer cette vente ?')) {
              const updatedSales = sales.filter(sale => sale.id !== id);
              setSales(updatedSales);
              saveSales(updatedSales);
            }
          };

          const clearAllData = async () => {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es ? Cette action est irr√©versible.')) {
              setSales([]);
              await storage.delete('sales-data');
            }
          };

          const getFilteredSales = () => {
            if (!dateFilter.startDate && !dateFilter.endDate) {
              return sales;
            }
            return sales.filter(sale => {
              const saleDate = new Date(sale.date);
              const start = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
              const end = dateFilter.endDate ? new Date(dateFilter.endDate) : null;

              if (start && end) {
                return saleDate >= start && saleDate <= end;
              } else if (start) {
                return saleDate >= start;
              } else if (end) {
                return saleDate <= end;
              }
              return true;
            });
          };

          const calculateTotal = () => {
            return getFilteredSales().reduce((sum, sale) => sum + sale.total, 0);
          };

          // Analyse des produits les plus vendus
          const getTopProducts = () => {
            const filteredSales = getFilteredSales();
            const productStats = {};

            filteredSales.forEach(sale => {
              const productName = sale.article.toUpperCase();
              if (!productStats[productName]) {
                productStats[productName] = {
                  name: sale.article,
                  totalQuantity: 0,
                  totalRevenue: 0,
                  salesCount: 0,
                  avgPrice: 0
                };
              }
              productStats[productName].totalQuantity += sale.quantity;
              productStats[productName].totalRevenue += sale.total;
              productStats[productName].salesCount += 1;
            });

            // Calculer le prix moyen
            Object.keys(productStats).forEach(key => {
              const product = productStats[key];
              product.avgPrice = product.totalRevenue / product.totalQuantity;
            });

            // Convertir en tableau et trier
            return Object.values(productStats)
              .sort((a, b) => b.totalRevenue - a.totalRevenue);
          };

          const filteredSales = getFilteredSales();
          const sortedSales = [...filteredSales].sort((a, b) => new Date(b.date) - new Date(a.date));
          const topProducts = getTopProducts();

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">üìä Gestion des Ventes - KYA DRINKS</h1>
                  <p className="text-gray-600">Suivez vos ventes et analysez vos revenus</p>
                </div>

                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-lg p-8 mb-6 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-lg font-medium mb-2 opacity-90">üí∞ Total de toutes les ventes</h2>
                      <div className="text-5xl font-bold">
                        {sales.reduce((sum, sale) => sum + sale.total, 0).toLocaleString()} XOF
                      </div>
                      <p className="text-sm mt-2 opacity-75">{sales.length} vente{sales.length > 1 ? 's' : ''} enregistr√©e{sales.length > 1 ? 's' : ''}</p>
                    </div>
                    <div className="text-6xl opacity-20">üìä</div>
                  </div>
                </div>

                <div className="flex flex-wrap gap-3 mb-6">
                  <button
                    onClick={() => setShowForm(!showForm)}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 font-medium transition-colors"
                  >
                    <Plus /> Ajouter une vente
                  </button>

                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".xlsx,.xls,.csv"
                    onChange={handleFileImport}
                    className="hidden"
                  />

                  <button
                    onClick={() => fileInputRef.current?.click()}
                    disabled={importing}
                    className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 font-medium transition-colors"
                  >
                    <FileSpreadsheet /> {importing ? 'Importation...' : 'Importer Excel'}
                  </button>

                  <button
                    onClick={() => setShowTopProducts(!showTopProducts)}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 font-medium transition-colors"
                  >
                    <TrendingUp /> {showTopProducts ? 'Masquer' : 'Produits vendus'}
                  </button>

                  {sales.length > 0 && (
                    <>
                      <button
                        onClick={exportToExcel}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 font-medium transition-colors"
                      >
                        <Download /> Exporter Excel
                      </button>

                      <button
                        onClick={clearAllData}
                        className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 font-medium transition-colors"
                      >
                        <Trash2 /> Tout supprimer
                      </button>
                    </>
                  )}
                </div>

                {sales.length === 0 && (
                  <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                    <h3 className="font-bold text-blue-900 mb-2">üí° Comment importer vos donn√©es Excel ?</h3>
                    <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                      <li>Cr√©ez un fichier Excel avec les colonnes : <strong>Date | Article | Quantit√© | Prix Unitaire | Total</strong></li>
                      <li>Format de date : <strong>21/01/2026</strong> ou <strong>2026-01-21</strong></li>
                      <li>Sauvegardez en .xlsx ou .csv</li>
                      <li>Cliquez sur "Importer Excel" et s√©lectionnez votre fichier</li>
                    </ol>
                  </div>
                )}

                {/* TOP PRODUITS */}
                {showTopProducts && topProducts.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <Award /> Top Produits Vendus
                    </h3>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-purple-600 text-white">
                          <tr>
                            <th className="px-4 py-3 text-left">Rang</th>
                            <th className="px-4 py-3 text-left">Produit</th>
                            <th className="px-4 py-3 text-center">Quantit√© vendue</th>
                            <th className="px-4 py-3 text-right">Chiffre d'affaires</th>
                            <th className="px-4 py-3 text-center">Nb de ventes</th>
                            <th className="px-4 py-3 text-right">Prix moyen</th>
                          </tr>
                        </thead>
                        <tbody>
                          {topProducts.map((product, index) => (
                            <tr key={index} className={`border-b hover:bg-gray-50 ${index < 3 ? 'bg-yellow-50' : ''}`}>
                              <td className="px-4 py-3 font-bold">
                                {index === 0 && 'ü•á'}
                                {index === 1 && 'ü•à'}
                                {index === 2 && 'ü•â'}
                                {index > 2 && `#${index + 1}`}
                              </td>
                              <td className="px-4 py-3 font-medium">{product.name}</td>
                              <td className="px-4 py-3 text-center font-bold text-indigo-600">{product.totalQuantity}</td>
                              <td className="px-4 py-3 text-right font-bold text-green-600">
                                {product.totalRevenue.toLocaleString()} XOF
                              </td>
                              <td className="px-4 py-3 text-center">{product.salesCount}</td>
                              <td className="px-4 py-3 text-right">{Math.round(product.avgPrice).toLocaleString()} XOF</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">üîç Filtrer par p√©riode</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        <Calendar /> Date d√©but
                      </label>
                      <input
                        type="date"
                        value={dateFilter.startDate}
                        onChange={(e) => setDateFilter({...dateFilter, startDate: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        <Calendar /> Date fin
                      </label>
                      <input
                        type="date"
                        value={dateFilter.endDate}
                        onChange={(e) => setDateFilter({...dateFilter, endDate: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        <DollarSign /> Total de la p√©riode
                      </label>
                      <div className="text-3xl font-bold text-indigo-600">
                        {calculateTotal().toLocaleString()} XOF
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => setDateFilter({startDate: '', endDate: ''})}
                    className="text-sm text-indigo-600 hover:text-indigo-800 font-medium"
                  >
                    R√©initialiser les filtres
                  </button>
                </div>

                {showForm && (
                  <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Nouvelle vente</h2>
                    <form onSubmit={handleSubmit}>
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                          <input
                            type="date"
                            value={formData.date}
                            onChange={(e) => setFormData({...formData, date: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Article</label>
                          <input
                            type="text"
                            value={formData.article}
                            onChange={(e) => setFormData({...formData, article: e.target.value})}
                            placeholder="Nom de l'article"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Quantit√©</label>
                          <input
                            type="number"
                            value={formData.quantity}
                            onChange={(e) => setFormData({...formData, quantity: parseInt(e.target.value) || 1})}
                            min="1"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Prix unitaire (XOF)</label>
                          <input
                            type="number"
                            value={formData.unitPrice}
                            onChange={(e) => setFormData({...formData, unitPrice: e.target.value})}
                            placeholder="0"
                            min="0"
                            step="0.01"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          />
                        </div>
                        <div className="md:col-span-4 flex gap-2">
                          <button
                            type="submit"
                            className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                          >
                            Enregistrer
                          </button>
                          <button
                            type="button"
                            onClick={() => setShowForm(false)}
                            className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors"
                          >
                            Annuler
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                )}

                <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-indigo-600 text-white">
                        <tr>
                          <th className="px-4 py-3 text-left">Date</th>
                          <th className="px-4 py-3 text-left">Article</th>
                          <th className="px-4 py-3 text-center">Quantit√©</th>
                          <th className="px-4 py-3 text-right">Prix Unit.</th>
                          <th className="px-4 py-3 text-right">Total</th>
                          <th className="px-4 py-3 text-center">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sortedSales.length === 0 ? (
                          <tr>
                            <td colSpan="6" className="px-4 py-8 text-center text-gray-500">
                              <div className="flex flex-col items-center">
                                <Package />
                                <p className="mt-2">Aucune vente enregistr√©e</p>
                                <p className="text-sm text-gray-400 mt-1">Importez un fichier Excel ou ajoutez manuellement</p>
                              </div>
                            </td>
                          </tr>
                        ) : (
                          sortedSales.map((sale) => (
                            <tr key={sale.id} className="border-b hover:bg-gray-50">
                              <td className="px-4 py-3">{new Date(sale.date).toLocaleDateString('fr-FR')}</td>
                              <td className="px-4 py-3 font-medium">{sale.article}</td>
                              <td className="px-4 py-3 text-center">{sale.quantity}</td>
                              <td className="px-4 py-3 text-right">{sale.unitPrice.toLocaleString()} XOF</td>
                              <td className="px-4 py-3 text-right font-bold text-indigo-600">
                                {sale.total.toLocaleString()} XOF
                              </td>
                              <td className="px-4 py-3 text-center">
                                <button
                                  onClick={() => deleteSale(sale.id)}
                                  className="text-red-600 hover:text-red-800 transition-colors"
                                  title="Supprimer"
                                >
                                  <Trash2 />
                                </button>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {filteredSales.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">üìà Statistiques</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <div className="text-sm text-gray-600 mb-1">Nombre de ventes</div>
                        <div className="text-2xl font-bold text-blue-600">{filteredSales.length}</div>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg">
                        <div className="text-sm text-gray-600 mb-1">Total des ventes</div>
                        <div className="text-2xl font-bold text-green-600">
                          {calculateTotal().toLocaleString()} XOF
                        </div>
                      </div>
                      <div className="bg-purple-50 p-4 rounded-lg">
                        <div className="text-sm text-gray-600 mb-1">Vente moyenne</div>
                        <div className="text-2xl font-bold text-purple-600">
                          {Math.round(calculateTotal() / filteredSales.length).toLocaleString()} XOF
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<SalesTracker />, document.getElementById('root'));
    </script>
</body>
</html>
