<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion - KYA DRINKS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const storage = {
          get: async (key) => {
            try {
              const value = localStorage.getItem(key);
              return value ? { key, value } : null;
            } catch (error) {
              console.error('Erreur lecture storage:', error);
              return null;
            }
          },
          set: async (key, value) => {
            try {
              localStorage.setItem(key, value);
              return { key, value };
            } catch (error) {
              console.error('Erreur √©criture storage:', error);
              return null;
            }
          },
          delete: async (key) => {
            try {
              localStorage.removeItem(key);
              return { key, deleted: true };
            } catch (error) {
              console.error('Erreur suppression storage:', error);
              return null;
            }
          }
        };

        // Icons
        const Plus = () => <span>‚ûï</span>;
        const Trash2 = () => <span>üóëÔ∏è</span>;
        const Calendar = () => <span>üìÖ</span>;
        const DollarSign = () => <span>üí∞</span>;
        const Package = () => <span>üì¶</span>;
        const Upload = () => <span>‚¨ÜÔ∏è</span>;
        const Download = () => <span>‚¨áÔ∏è</span>;
        const FileSpreadsheet = () => <span>üìä</span>;
        const TrendingUp = () => <span>üìà</span>;
        const Award = () => <span>üèÜ</span>;
        const Wallet = () => <span>üí≥</span>;
        const Receipt = () => <span>üßæ</span>;

        function App() {
          const [activeTab, setActiveTab] = useState('sales');

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              {/* Header with Tabs */}
              <div className="bg-white shadow-md">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex items-center justify-between py-4">
                    <h1 className="text-2xl font-bold text-indigo-600">KYA DRINKS</h1>
                  </div>
                  <div className="flex space-x-1 border-b">
                    <button
                      onClick={() => setActiveTab('sales')}
                      className={`px-6 py-3 font-medium transition-colors ${
                        activeTab === 'sales'
                          ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50'
                          : 'text-gray-600 hover:text-indigo-600 hover:bg-gray-50'
                      }`}
                    >
                      <FileSpreadsheet /> Ventes
                    </button>
                    <button
                      onClick={() => setActiveTab('budget')}
                      className={`px-6 py-3 font-medium transition-colors ${
                        activeTab === 'budget'
                          ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50'
                          : 'text-gray-600 hover:text-indigo-600 hover:bg-gray-50'
                      }`}
                    >
                      <Wallet /> Solde Budg√©taire
                    </button>
                  </div>
                </div>
              </div>

              {/* Tab Content */}
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                {activeTab === 'sales' && <SalesTracker />}
                {activeTab === 'budget' && <BudgetTracker />}
              </div>
            </div>
          );
        }

        function BudgetTracker() {
          const [sales, setSales] = useState([]);
          const [expenses, setExpenses] = useState([]);
          const [showExpenseForm, setShowExpenseForm] = useState(false);
          const [expenseForm, setExpenseForm] = useState({
            date: new Date().toISOString().split('T')[0],
            category: '',
            description: '',
            amount: ''
          });
          const [dateFilter, setDateFilter] = useState({
            startDate: '',
            endDate: ''
          });

          useEffect(() => {
            loadBudgetData();
          }, []);

          const loadBudgetData = async () => {
            try {
              const expensesResult = await storage.get('expenses-data');
              if (expensesResult && expensesResult.value) {
                setExpenses(JSON.parse(expensesResult.value));
              }

              const salesResult = await storage.get('sales-data');
              if (salesResult && salesResult.value) {
                setSales(JSON.parse(salesResult.value));
              }
            } catch (error) {
              console.log('Aucune donn√©e budg√©taire sauvegard√©e');
            }
          };

          const saveExpenses = async (newExpenses) => {
            try {
              await storage.set('expenses-data', JSON.stringify(newExpenses));
            } catch (error) {
              console.error('Erreur de sauvegarde:', error);
            }
          };

          const handleExpenseSubmit = (e) => {
            e.preventDefault();
            const newExpense = {
              id: Date.now(),
              date: expenseForm.date,
              category: expenseForm.category,
              description: expenseForm.description,
              amount: parseFloat(expenseForm.amount)
            };

            const updatedExpenses = [...expenses, newExpense];
            setExpenses(updatedExpenses);
            saveExpenses(updatedExpenses);

            setExpenseForm({
              date: new Date().toISOString().split('T')[0],
              category: '',
              description: '',
              amount: ''
            });
            setShowExpenseForm(false);
          };

          const deleteExpense = (id) => {
            if (window.confirm('Voulez-vous vraiment supprimer cette d√©pense ?')) {
              const updatedExpenses = expenses.filter(exp => exp.id !== id);
              setExpenses(updatedExpenses);
              saveExpenses(updatedExpenses);
            }
          };

          const filterByDate = (items) => {
            return items.filter(item => {
              if (!dateFilter.startDate && !dateFilter.endDate) return true;
              const itemDate = new Date(item.date);
              const start = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
              const end = dateFilter.endDate ? new Date(dateFilter.endDate) : null;

              if (start && end) {
                return itemDate >= start && itemDate <= end;
              } else if (start) {
                return itemDate >= start;
              } else if (end) {
                return itemDate <= end;
              }
              return true;
            });
          };

          const filteredExpenses = filterByDate(expenses);
          const filteredSales = filterByDate(sales);

          const sortedExpenses = [...filteredExpenses].sort((a, b) =>
            new Date(b.date) - new Date(a.date)
          );

          const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
          const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);
          const balance = totalRevenue - totalExpenses;
          const expensePercentage = totalRevenue > 0 ? (totalExpenses / totalRevenue) * 100 : 0;

          const expensesByCategory = filteredExpenses.reduce((acc, expense) => {
            if (!acc[expense.category]) {
              acc[expense.category] = 0;
            }
            acc[expense.category] += expense.amount;
            return acc;
          }, {});

          return (
            <div>
              {/* Date Filter - Now at the top */}
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  <Calendar /> Filtrer par p√©riode
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Date d√©but</label>
                    <input
                      type="date"
                      value={dateFilter.startDate}
                      onChange={(e) => setDateFilter({...dateFilter, startDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                    <input
                      type="date"
                      value={dateFilter.endDate}
                      onChange={(e) => setDateFilter({...dateFilter, endDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                </div>
                <button
                  onClick={() => setDateFilter({startDate: '', endDate: ''})}
                  className="text-sm text-indigo-600 hover:text-indigo-800 font-medium mt-4"
                >
                  R√©initialiser les filtres
                </button>
                {(dateFilter.startDate || dateFilter.endDate) && (
                  <div className="mt-3 text-sm text-gray-600">
                    üìä P√©riode: {dateFilter.startDate ? new Date(dateFilter.startDate).toLocaleDateString('fr-FR') : 'D√©but'} ‚Üí {dateFilter.endDate ? new Date(dateFilter.endDate).toLocaleDateString('fr-FR') : 'Aujourd\'hui'}
                  </div>
                )}
              </div>

              {/* Budget Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-medium text-gray-600">Revenus (Ventes)</h3>
                    <TrendingUp />
                  </div>
                  <div className="text-2xl font-bold text-green-600">
                    {totalRevenue.toLocaleString()} <span className="text-sm text-gray-500">XOF</span>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">{filteredSales.length} vente(s)</div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-medium text-gray-600">D√©penses Totales</h3>
                    <Receipt />
                  </div>
                  <div className="text-2xl font-bold text-red-600">
                    {totalExpenses.toLocaleString()} <span className="text-sm text-gray-500">XOF</span>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">{filteredExpenses.length} d√©pense(s)</div>
                  {totalRevenue > 0 && (
                    <div className="mt-2">
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                          className={`h-2 rounded-full ${expensePercentage > 100 ? 'bg-red-600' : expensePercentage > 75 ? 'bg-orange-500' : 'bg-green-500'}`}
                          style={{ width: `${Math.min(expensePercentage, 100)}%` }}
                        ></div>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">{expensePercentage.toFixed(1)}% des revenus</p>
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6 md:col-span-2">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-medium text-gray-600">Solde de la p√©riode</h3>
                    <Wallet />
                  </div>
                  <div className={`text-3xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {balance.toLocaleString()} <span className="text-base text-gray-500">XOF</span>
                  </div>
                  <div className="text-sm text-gray-600 mt-2">
                    {balance >= 0 ? '‚úÖ Solde positif' : '‚ö†Ô∏è Solde n√©gatif - D√©penses sup√©rieures aux revenus'}
                  </div>
                  {balance >= 0 && totalRevenue > 0 && (
                    <div className="text-xs text-gray-500 mt-1">
                      Marge b√©n√©ficiaire: {((balance / totalRevenue) * 100).toFixed(1)}%
                    </div>
                  )}
                </div>
              </div>

              {/* Action Buttons */}
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex flex-wrap gap-3">
                  <button
                    onClick={() => setShowExpenseForm(!showExpenseForm)}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    <Plus /> Ajouter une d√©pense
                  </button>

                  {expenses.length > 0 && (
                    <button
                      onClick={() => {
                        if (window.confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer TOUTES les d√©penses ? Cette action est irr√©versible.')) {
                          setExpenses([]);
                          saveExpenses([]);
                        }
                      }}
                      className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ml-auto"
                    >
                      <Trash2 /> Tout supprimer
                    </button>
                  )}
                </div>
              </div>

              {/* Expense Form */}
              {showExpenseForm && (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Nouvelle d√©pense</h2>
                  <form onSubmit={handleExpenseSubmit}>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input
                          type="date"
                          value={expenseForm.date}
                          onChange={(e) => setExpenseForm({...expenseForm, date: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
                        <select
                          value={expenseForm.category}
                          onChange={(e) => setExpenseForm({...expenseForm, category: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        >
                          <option value="">S√©lectionner une cat√©gorie</option>
                          <option value="Approvisionnement">Approvisionnement</option>
                          <option value="Transport">Transport</option>
                          <option value="Salaires">Salaires</option>
                          <option value="Loyer">Loyer</option>
                          <option value="√âlectricit√©">√âlectricit√©</option>
                          <option value="Marketing">Marketing</option>
                          <option value="√âquipement">√âquipement</option>
                          <option value="Maintenance">Maintenance</option>
                          <option value="Autres">Autres</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input
                          type="text"
                          value={expenseForm.description}
                          onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                          placeholder="Description de la d√©pense"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Montant (XOF)</label>
                        <input
                          type="number"
                          value={expenseForm.amount}
                          onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                          placeholder="0"
                          min="0"
                          step="0.01"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div className="md:col-span-2 flex gap-2">
                        <button
                          type="submit"
                          className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                          Enregistrer
                        </button>
                        <button
                          type="button"
                          onClick={() => setShowExpenseForm(false)}
                          className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                          Annuler
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              )}

              {/* Expenses by Category */}
              {Object.keys(expensesByCategory).length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">D√©penses par cat√©gorie</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {Object.entries(expensesByCategory)
                      .sort((a, b) => b[1] - a[1])
                      .map(([category, amount]) => (
                        <div key={category} className="bg-gray-50 p-4 rounded-lg">
                          <div className="text-sm text-gray-600 mb-1">{category}</div>
                          <div className="text-xl font-bold text-indigo-600">
                            {amount.toLocaleString()} XOF
                          </div>
                          {totalRevenue > 0 && (
                            <div className="text-xs text-gray-500 mt-1">
                              {((amount / totalRevenue) * 100).toFixed(1)}% des revenus
                            </div>
                          )}
                          {totalExpenses > 0 && (
                            <div className="text-xs text-gray-400 mt-1">
                              {((amount / totalExpenses) * 100).toFixed(1)}% des d√©penses totales
                            </div>
                          )}
                        </div>
                      ))}
                  </div>
                </div>
              )}

              {/* Expenses Table */}
              <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-indigo-600 text-white">
                      <tr>
                        <th className="px-4 py-3 text-left">Date</th>
                        <th className="px-4 py-3 text-left">Cat√©gorie</th>
                        <th className="px-4 py-3 text-left">Description</th>
                        <th className="px-4 py-3 text-right">Montant</th>
                        <th className="px-4 py-3 text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {sortedExpenses.length === 0 ? (
                        <tr>
                          <td colSpan="5" className="px-4 py-8 text-center text-gray-500">
                            <div className="flex flex-col items-center">
                              <Receipt />
                              <p className="mt-2">Aucune d√©pense enregistr√©e pour cette p√©riode</p>
                              <p className="text-sm text-gray-400 mt-1">Ajoutez vos premi√®res d√©penses</p>
                            </div>
                          </td>
                        </tr>
                      ) : (
                        sortedExpenses.map((expense) => (
                          <tr key={expense.id} className="border-b hover:bg-gray-50">
                            <td className="px-4 py-3">{new Date(expense.date).toLocaleDateString('fr-FR')}</td>
                            <td className="px-4 py-3">
                              <span className="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm">
                                {expense.category}
                              </span>
                            </td>
                            <td className="px-4 py-3">{expense.description}</td>
                            <td className="px-4 py-3 text-right font-bold text-red-600">
                              {expense.amount.toLocaleString()} XOF
                            </td>
                            <td className="px-4 py-3 text-center">
                              <button
                                onClick={() => deleteExpense(expense.id)}
                                className="text-red-600 hover:text-red-800 transition-colors"
                                title="Supprimer"
                              >
                                <Trash2 />
                              </button>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        }

        function SalesTracker() {
          const [sales, setSales] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [showTopProducts, setShowTopProducts] = useState(false);
          const [formData, setFormData] = useState({
            date: new Date().toISOString().split('T')[0],
            article: '',
            quantity: 1,
            unitPrice: ''
          });
          const [dateFilter, setDateFilter] = useState({
            startDate: '',
            endDate: ''
          });
          const [importing, setImporting] = useState(false);
          const fileInputRef = useRef(null);

          useEffect(() => {
            loadSales();
          }, []);

          const loadSales = async () => {
            try {
              const result = await storage.get('sales-data');
              if (result && result.value) {
                setSales(JSON.parse(result.value));
              }
            } catch (error) {
              console.log('Aucune donn√©e sauvegard√©e');
            }
          };

          const saveSales = async (newSales) => {
            try {
              await storage.set('sales-data', JSON.stringify(newSales));
            } catch (error) {
              console.error('Erreur de sauvegarde:', error);
            }
          };

          const parseExcelDate = (dateValue) => {
            if (!dateValue) return null;

            if (typeof dateValue === 'string') {
              const parts = dateValue.split('/');
              if (parts.length === 3) {
                const [day, month, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              }
              if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateValue;
              }
            }

            if (typeof dateValue === 'number') {
              const date = new Date((dateValue - 25569) * 86400 * 1000);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }

            return null;
          };

          const handleFileImport = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setImporting(true);
            try {
              const data = await file.arrayBuffer();
              const workbook = XLSX.read(data);
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);

              const importedSales = jsonData
                .map((row, index) => {
                  const date = parseExcelDate(
                    row['Date'] || row['date'] || row['DATE']
                  );
                  const article = row['Article'] || row['article'] || row['ARTICLE'] || '';
                  const quantity = parseInt(row['Quantit√©'] || row['Quantite'] || row['quantity'] || row['QUANTITY'] || 1);
                  const unitPrice = parseFloat(
                    String(row['Prix Unitaire'] || row['Prix Unit.'] || row['unitPrice'] || row['PRIX UNITAIRE'] || 0)
                      .replace(/\s/g, '')
                      .replace('XOF', '')
                      .replace(',', '.')
                  );
                  const total = parseFloat(
                    String(row['Total'] || row['total'] || row['TOTAL'] || (quantity * unitPrice))
                      .replace(/\s/g, '')
                      .replace('XOF', '')
                      .replace(',', '.')
                  );

                  if (!date || !article || !unitPrice) {
                    console.warn(`Ligne ${index + 2} ignor√©e:`, row);
                    return null;
                  }

                  return {
                    id: Date.now() + index,
                    date,
                    article: article.trim(),
                    quantity,
                    unitPrice,
                    total
                  };
                })
                .filter(Boolean);

              if (importedSales.length === 0) {
                alert('‚ùå Aucune donn√©e valide trouv√©e dans le fichier.\n\nAssurez-vous que les colonnes sont nomm√©es:\n- Date\n- Article\n- Quantit√©\n- Prix Unitaire\n- Total');
                setImporting(false);
                return;
              }

              const newSales = [...sales, ...importedSales];
              setSales(newSales);
              saveSales(newSales);
              alert(`‚úÖ ${importedSales.length} vente(s) import√©e(s) avec succ√®s !`);
            } catch (error) {
              console.error('Erreur import:', error);
              alert('‚ùå Erreur lors de l\'importation du fichier.\n\nV√©rifiez que c\'est bien un fichier Excel (.xlsx ou .xls)');
            } finally {
              setImporting(false);
              if (fileInputRef.current) {
                fileInputRef.current.value = '';
              }
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            const newSale = {
              id: Date.now(),
              date: formData.date,
              article: formData.article,
              quantity: formData.quantity,
              unitPrice: parseFloat(formData.unitPrice),
              total: formData.quantity * parseFloat(formData.unitPrice)
            };

            const newSales = [...sales, newSale];
            setSales(newSales);
            saveSales(newSales);

            setFormData({
              date: new Date().toISOString().split('T')[0],
              article: '',
              quantity: 1,
              unitPrice: ''
            });
            setShowForm(false);
          };

          const deleteSale = (id) => {
            if (window.confirm('Voulez-vous vraiment supprimer cette vente ?')) {
              const newSales = sales.filter(sale => sale.id !== id);
              setSales(newSales);
              saveSales(newSales);
            }
          };

          const exportToExcel = () => {
            if (filteredSales.length === 0) {
              alert('Aucune donn√©e √† exporter');
              return;
            }

            const exportData = filteredSales.map(sale => ({
              'Date': new Date(sale.date).toLocaleDateString('fr-FR'),
              'Article': sale.article,
              'Quantit√©': sale.quantity,
              'Prix Unitaire': sale.unitPrice,
              'Total': sale.total
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ventes');

            const fileName = `ventes_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
          };

          const filteredSales = sales.filter(sale => {
            if (!dateFilter.startDate && !dateFilter.endDate) return true;
            const saleDate = new Date(sale.date);
            const start = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
            const end = dateFilter.endDate ? new Date(dateFilter.endDate) : null;

            if (start && end) {
              return saleDate >= start && saleDate <= end;
            } else if (start) {
              return saleDate >= start;
            } else if (end) {
              return saleDate <= end;
            }
            return true;
          });

          const sortedSales = [...filteredSales].sort((a, b) =>
            new Date(b.date) - new Date(a.date)
          );

          const calculateTotal = () => {
            return filteredSales.reduce((sum, sale) => sum + sale.total, 0);
          };

          const getTopProducts = () => {
            const productStats = {};
            filteredSales.forEach(sale => {
              if (!productStats[sale.article]) {
                productStats[sale.article] = {
                  article: sale.article,
                  totalQuantity: 0,
                  totalRevenue: 0,
                  salesCount: 0
                };
              }
              productStats[sale.article].totalQuantity += sale.quantity;
              productStats[sale.article].totalRevenue += sale.total;
              productStats[sale.article].salesCount += 1;
            });

            return Object.values(productStats)
              .sort((a, b) => b.totalRevenue - a.totalRevenue)
              .slice(0, 5);
          };

          return (
            <div>
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex flex-wrap gap-3">
                  <button
                    onClick={() => setShowForm(!showForm)}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    <Plus /> Ajouter une vente
                  </button>

                  <label className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center gap-2">
                    <Upload /> {importing ? 'Importation...' : 'Importer Excel'}
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".xlsx,.xls"
                      onChange={handleFileImport}
                      className="hidden"
                      disabled={importing}
                    />
                  </label>

                  <button
                    onClick={exportToExcel}
                    className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    <Download /> Exporter Excel
                  </button>

                  <button
                    onClick={() => setShowTopProducts(!showTopProducts)}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    <Award /> Top Produits
                  </button>

                  {sales.length > 0 && (
                    <button
                      onClick={() => {
                        if (window.confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer TOUTES les ventes ? Cette action est irr√©versible.')) {
                          setSales([]);
                          saveSales([]);
                        }
                      }}
                      className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ml-auto"
                    >
                      <Trash2 /> Tout supprimer
                    </button>
                  )}
                </div>
              </div>

              {showTopProducts && (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">
                    <Award /> Top 5 des produits
                  </h2>
                  <div className="space-y-3">
                    {getTopProducts().map((product, index) => (
                      <div key={product.article} className="flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl font-bold text-purple-600">#{index + 1}</span>
                          <div>
                            <div className="font-bold text-gray-800">{product.article}</div>
                            <div className="text-sm text-gray-600">
                              {product.totalQuantity} unit√©s vendues ‚Ä¢ {product.salesCount} ventes
                            </div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-xl font-bold text-purple-600">
                            {product.totalRevenue.toLocaleString()} XOF
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  <Calendar /> Filtrer par p√©riode
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Date d√©but</label>
                    <input
                      type="date"
                      value={dateFilter.startDate}
                      onChange={(e) => setDateFilter({...dateFilter, startDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                    <input
                      type="date"
                      value={dateFilter.endDate}
                      onChange={(e) => setDateFilter({...dateFilter, endDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      <DollarSign /> Total de la p√©riode
                    </label>
                    <div className="text-3xl font-bold text-indigo-600">
                      {calculateTotal().toLocaleString()} XOF
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => setDateFilter({startDate: '', endDate: ''})}
                  className="text-sm text-indigo-600 hover:text-indigo-800 font-medium mt-4"
                >
                  R√©initialiser les filtres
                </button>
              </div>

              {showForm && (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Nouvelle vente</h2>
                  <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input
                          type="date"
                          value={formData.date}
                          onChange={(e) => setFormData({...formData, date: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Article</label>
                        <input
                          type="text"
                          value={formData.article}
                          onChange={(e) => setFormData({...formData, article: e.target.value})}
                          placeholder="Nom de l'article"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantit√©</label>
                        <input
                          type="number"
                          value={formData.quantity}
                          onChange={(e) => setFormData({...formData, quantity: parseInt(e.target.value) || 1})}
                          min="1"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Prix unitaire (XOF)</label>
                        <input
                          type="number"
                          value={formData.unitPrice}
                          onChange={(e) => setFormData({...formData, unitPrice: e.target.value})}
                          placeholder="0"
                          min="0"
                          step="0.01"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          required
                        />
                      </div>
                      <div className="md:col-span-4 flex gap-2">
                        <button
                          type="submit"
                          className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                          Enregistrer
                        </button>
                        <button
                          type="button"
                          onClick={() => setShowForm(false)}
                          className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                          Annuler
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              )}

              <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-indigo-600 text-white">
                      <tr>
                        <th className="px-4 py-3 text-left">Date</th>
                        <th className="px-4 py-3 text-left">Article</th>
                        <th className="px-4 py-3 text-center">Quantit√©</th>
                        <th className="px-4 py-3 text-right">Prix Unit.</th>
                        <th className="px-4 py-3 text-right">Total</th>
                        <th className="px-4 py-3 text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {sortedSales.length === 0 ? (
                        <tr>
                          <td colSpan="6" className="px-4 py-8 text-center text-gray-500">
                            <div className="flex flex-col items-center">
                              <Package />
                              <p className="mt-2">Aucune vente enregistr√©e</p>
                              <p className="text-sm text-gray-400 mt-1">Importez un fichier Excel ou ajoutez manuellement</p>
                            </div>
                          </td>
                        </tr>
                      ) : (
                        sortedSales.map((sale) => (
                          <tr key={sale.id} className="border-b hover:bg-gray-50">
                            <td className="px-4 py-3">{new Date(sale.date).toLocaleDateString('fr-FR')}</td>
                            <td className="px-4 py-3 font-medium">{sale.article}</td>
                            <td className="px-4 py-3 text-center">{sale.quantity}</td>
                            <td className="px-4 py-3 text-right">{sale.unitPrice.toLocaleString()} XOF</td>
                            <td className="px-4 py-3 text-right font-bold text-indigo-600">
                              {sale.total.toLocaleString()} XOF
                            </td>
                            <td className="px-4 py-3 text-center">
                              <button
                                onClick={() => deleteSale(sale.id)}
                                className="text-red-600 hover:text-red-800 transition-colors"
                                title="Supprimer"
                              >
                                <Trash2 />
                              </button>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {filteredSales.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">üìà Statistiques</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-blue-50 p-4 rounded-lg">
                      <div className="text-sm text-gray-600 mb-1">Nombre de ventes</div>
                      <div className="text-2xl font-bold text-blue-600">{filteredSales.length}</div>
                    </div>
                    <div className="bg-green-50 p-4 rounded-lg">
                      <div className="text-sm text-gray-600 mb-1">Total des ventes</div>
                      <div className="text-2xl font-bold text-green-600">
                        {calculateTotal().toLocaleString()} XOF
                      </div>
                    </div>
                    <div className="bg-purple-50 p-4 rounded-lg">
                      <div className="text-sm text-gray-600 mb-1">Vente moyenne</div>
                      <div className="text-2xl font-bold text-purple-600">
                        {Math.round(calculateTotal() / filteredSales.length).toLocaleString()} XOF
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
